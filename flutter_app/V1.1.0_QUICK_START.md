# v1.1.0 å¿«é€Ÿå¼€å§‹æŒ‡å—

> è¿™æ˜¯ä¸€ä¸ªç²¾ç®€çš„å¼€å‘æŒ‡å—ï¼Œå¸®åŠ©ä½ å¿«é€Ÿå¼€å§‹ v1.1.0 çš„å¼€å‘å·¥ä½œ

---

## ğŸš€ ç«‹å³å¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¯å¢ƒ

```bash
# 1. ç¡®ä¿ Flutter ç¯å¢ƒæ­£å¸¸
flutter doctor

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd flutter_app

# 3. å®‰è£…ä¾èµ–
flutter pub get

# 4. æ·»åŠ æ–°ä¾èµ–åˆ° pubspec.yaml
```

åœ¨ `pubspec.yaml` ä¸­æ·»åŠ ï¼š

```yaml
dependencies:
  window_manager: ^0.3.7
  audioplayers: ^5.2.1
  flutter_heatmap_calendar: ^1.0.5
  uuid: ^4.2.1
```

ç„¶åè¿è¡Œï¼š
```bash
flutter pub get
```

---

## ğŸ“ Phase 1: æ•°æ®æ¨¡å‹ï¼ˆç¬¬ä¸€å‘¨ï¼‰

### ä»»åŠ¡æ¸…å•

#### 1. åˆ›å»º Project æ¨¡å‹ (30åˆ†é’Ÿ)

åˆ›å»ºæ–‡ä»¶ `lib/core/models/project.dart`:

```dart
import 'package:hive/hive.dart';
import 'package:uuid/uuid.dart';

part 'project.g.dart';

@HiveType(typeId: 4)
class Project extends HiveObject {
  @HiveField(0)
  final String id;

  @HiveField(1)
  final String name;

  @HiveField(2)
  final double estimatedHours;

  @HiveField(3)
  final double actualHours;

  @HiveField(4)
  final String status; // 'active', 'completed', 'archived'

  @HiveField(5)
  final DateTime createdAt;

  @HiveField(6)
  final DateTime? completedAt;

  @HiveField(7)
  final String? description;

  @HiveField(8)
  final int rewardGold;

  @HiveField(9)
  final int rewardExp;

  Project({
    String? id,
    required this.name,
    required this.estimatedHours,
    this.actualHours = 0,
    this.status = 'active',
    DateTime? createdAt,
    this.completedAt,
    this.description,
    int? rewardGold,
    int? rewardExp,
  })  : id = id ?? const Uuid().v4(),
        createdAt = createdAt ?? DateTime.now(),
        rewardGold = rewardGold ?? (estimatedHours * 10).toInt(),
        rewardExp = rewardExp ?? (estimatedHours * 50).toInt();

  // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
  double get progress => actualHours / estimatedHours;

  // æ˜¯å¦å®Œæˆ
  bool get isCompleted => actualHours >= estimatedHours;

  // å‰©ä½™å·¥æ—¶
  double get remainingHours => estimatedHours - actualHours;

  Project copyWith({
    String? name,
    double? estimatedHours,
    double? actualHours,
    String? status,
    DateTime? completedAt,
    String? description,
    int? rewardGold,
    int? rewardExp,
  }) {
    return Project(
      id: id,
      name: name ?? this.name,
      estimatedHours: estimatedHours ?? this.estimatedHours,
      actualHours: actualHours ?? this.actualHours,
      status: status ?? this.status,
      createdAt: createdAt,
      completedAt: completedAt ?? this.completedAt,
      description: description ?? this.description,
      rewardGold: rewardGold ?? this.rewardGold,
      rewardExp: rewardExp ?? this.rewardExp,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'estimatedHours': estimatedHours,
      'actualHours': actualHours,
      'status': status,
      'createdAt': createdAt.toIso8601String(),
      'completedAt': completedAt?.toIso8601String(),
      'description': description,
      'rewardGold': rewardGold,
      'rewardExp': rewardExp,
    };
  }

  factory Project.fromJson(Map<String, dynamic> json) {
    return Project(
      id: json['id'],
      name: json['name'],
      estimatedHours: json['estimatedHours'],
      actualHours: json['actualHours'] ?? 0,
      status: json['status'] ?? 'active',
      createdAt: DateTime.parse(json['createdAt']),
      completedAt: json['completedAt'] != null
          ? DateTime.parse(json['completedAt'])
          : null,
      description: json['description'],
      rewardGold: json['rewardGold'],
      rewardExp: json['rewardExp'],
    );
  }
}
```

#### 2. åˆ›å»ºå•†åº—æ¨¡å‹ (20åˆ†é’Ÿ)

åˆ›å»ºæ–‡ä»¶ `lib/core/models/shop_item.dart`:

```dart
import 'package:hive/hive.dart';

part 'shop_item.g.dart';

@HiveType(typeId: 5)
class ShopItem {
  @HiveField(0)
  final String id;

  @HiveField(1)
  final String name;

  @HiveField(2)
  final String description;

  @HiveField(3)
  final String type; // 'theme', 'ticket', 'decoration', 'boost'

  @HiveField(4)
  final int price;

  @HiveField(5)
  final String icon;

  @HiveField(6)
  final Map<String, dynamic>? data;

  ShopItem({
    required this.id,
    required this.name,
    required this.description,
    required this.type,
    required this.price,
    required this.icon,
    this.data,
  });

  // é¢„å®šä¹‰å•†å“
  static final List<ShopItem> defaultItems = [
    ShopItem(
      id: 'theme_cyberpunk',
      name: 'èµ›åšæœ‹å…‹ä¸»é¢˜',
      description: 'ç‚«é…·çš„ç´«è‰²éœ“è™¹ä¸»é¢˜',
      type: 'theme',
      price: 5000,
      icon: 'ğŸŒƒ',
      data: {'primaryColor': '0xFF9C27B0'},
    ),
    ShopItem(
      id: 'theme_matrix',
      name: 'é»‘å®¢å¸å›½ä¸»é¢˜',
      description: 'ç»å…¸çš„ç»¿è‰²çŸ©é˜µä¸»é¢˜',
      type: 'theme',
      price: 5000,
      icon: 'ğŸ’š',
      data: {'primaryColor': '0xFF4CAF50'},
    ),
    ShopItem(
      id: 'ticket_restore',
      name: 'å…ç­¾å¡',
      description: 'æ¢å¤ä¸€å¤©çš„è¿ç»­ç­¾åˆ°',
      type: 'ticket',
      price: 1000,
      icon: 'ğŸ«',
    ),
    ShopItem(
      id: 'decoration_keyboard',
      name: 'æœºæ¢°é”®ç›˜',
      description: 'æ¡Œé¢è£…é¥°ï¼šæœºæ¢°é”®ç›˜',
      type: 'decoration',
      price: 2000,
      icon: 'âŒ¨ï¸',
    ),
    ShopItem(
      id: 'decoration_coffee',
      name: 'å’–å•¡æœº',
      description: 'æ¡Œé¢è£…é¥°ï¼šå’–å•¡æœº',
      type: 'decoration',
      price: 3000,
      icon: 'â˜•',
    ),
  ];
}
```

åˆ›å»ºæ–‡ä»¶ `lib/core/models/inventory.dart`:

```dart
import 'package:hive/hive.dart';

part 'inventory.g.dart';

@HiveType(typeId: 6)
class Inventory extends HiveObject {
  @HiveField(0)
  final List<String> ownedItemIds;

  @HiveField(1)
  final String? activeTheme;

  @HiveField(2)
  final Map<String, int> consumables;

  Inventory({
    List<String>? ownedItemIds,
    this.activeTheme,
    Map<String, int>? consumables,
  })  : ownedItemIds = ownedItemIds ?? [],
        consumables = consumables ?? {};

  bool hasItem(String itemId) => ownedItemIds.contains(itemId);

  int getConsumableCount(String itemId) => consumables[itemId] ?? 0;

  Inventory copyWith({
    List<String>? ownedItemIds,
    String? activeTheme,
    Map<String, int>? consumables,
  }) {
    return Inventory(
      ownedItemIds: ownedItemIds ?? this.ownedItemIds,
      activeTheme: activeTheme ?? this.activeTheme,
      consumables: consumables ?? this.consumables,
    );
  }
}
```

#### 3. æ‰©å±•ç°æœ‰æ¨¡å‹ (20åˆ†é’Ÿ)

ä¿®æ”¹ `lib/core/models/adventurer_profile.dart`ï¼Œæ·»åŠ é‡‘å¸å­—æ®µï¼š

```dart
// åœ¨ AdventurerProfile ç±»ä¸­æ·»åŠ 
@HiveField(7)
final int gold;

@HiveField(8)
final int totalGoldEarned;

@HiveField(9)
final int totalGoldSpent;

// æ›´æ–°æ„é€ å‡½æ•°
AdventurerProfile({
  this.name = 'æ–°æ‰‹å†’é™©è€…',
  this.level = 1,
  this.experience = 0,
  this.totalWorkHours = 0,
  this.totalGold = 0,
  this.achievements = const [],
  this.consecutiveWorkDays = 0,
  this.gold = 0,                    // æ–°å¢
  this.totalGoldEarned = 0,         // æ–°å¢
  this.totalGoldSpent = 0,          // æ–°å¢
});

// æ·»åŠ é‡‘å¸ç›¸å…³æ–¹æ³•
AdventurerProfile addGold(int amount) {
  return copyWith(
    gold: gold + amount,
    totalGoldEarned: totalGoldEarned + amount,
  );
}

AdventurerProfile spendGold(int amount) {
  if (gold < amount) throw Exception('é‡‘å¸ä¸è¶³');
  return copyWith(
    gold: gold - amount,
    totalGoldSpent: totalGoldSpent + amount,
  );
}
```

ä¿®æ”¹ `lib/core/models/work_record.dart`ï¼Œæ·»åŠ é¡¹ç›®å…³è”ï¼š

```dart
// åœ¨ WorkRecord ç±»ä¸­æ·»åŠ 
@HiveField(6)
final String? projectId;

@HiveField(7)
final int goldEarned;

@HiveField(8)
final int expEarned;

// æ›´æ–°æ„é€ å‡½æ•°å’Œå·¥å‚æ–¹æ³•
```

#### 4. ç”Ÿæˆ Hive é€‚é…å™¨ (5åˆ†é’Ÿ)

```bash
flutter packages pub run build_runner build --delete-conflicting-outputs
```

#### 5. åˆ›å»º Repository (1å°æ—¶)

åˆ›å»º `lib/storage/project_repository.dart`:

```dart
import 'package:hive/hive.dart';
import '../core/models/project.dart';

class ProjectRepository {
  static const String _boxName = 'projects';
  late Box<Project> _box;

  Future<void> init() async {
    _box = await Hive.openBox<Project>(_boxName);
  }

  // è·å–æ‰€æœ‰é¡¹ç›®
  List<Project> getAllProjects() {
    return _box.values.toList();
  }

  // è·å–æ´»è·ƒé¡¹ç›®
  List<Project> getActiveProjects() {
    return _box.values.where((p) => p.status == 'active').toList();
  }

  // è·å–å•ä¸ªé¡¹ç›®
  Project? getProject(String id) {
    return _box.get(id);
  }

  // åˆ›å»ºé¡¹ç›®
  Future<void> createProject(Project project) async {
    await _box.put(project.id, project);
  }

  // æ›´æ–°é¡¹ç›®
  Future<void> updateProject(Project project) async {
    await _box.put(project.id, project);
  }

  // åˆ é™¤é¡¹ç›®
  Future<void> deleteProject(String id) async {
    await _box.delete(id);
  }

  // æ·»åŠ å·¥æ—¶åˆ°é¡¹ç›®
  Future<Project> addHoursToProject(String projectId, double hours) async {
    final project = getProject(projectId);
    if (project == null) throw Exception('é¡¹ç›®ä¸å­˜åœ¨');

    final updated = project.copyWith(
      actualHours: project.actualHours + hours,
      status: project.isCompleted ? 'completed' : 'active',
      completedAt: project.isCompleted ? DateTime.now() : null,
    );

    await updateProject(updated);
    return updated;
  }
}
```

åˆ›å»º `lib/storage/shop_repository.dart`:

```dart
import 'package:hive/hive.dart';
import '../core/models/inventory.dart';
import '../core/models/shop_item.dart';

class ShopRepository {
  static const String _boxName = 'inventory';
  late Box<Inventory> _box;

  Future<void> init() async {
    _box = await Hive.openBox<Inventory>(_boxName);
  }

  // è·å–åº“å­˜
  Inventory getInventory() {
    return _box.get('inventory', defaultValue: Inventory())!;
  }

  // ä¿å­˜åº“å­˜
  Future<void> saveInventory(Inventory inventory) async {
    await _box.put('inventory', inventory);
  }

  // è´­ä¹°ç‰©å“
  Future<void> purchaseItem(String itemId) async {
    final inventory = getInventory();
    final updated = inventory.copyWith(
      ownedItemIds: [...inventory.ownedItemIds, itemId],
    );
    await saveInventory(updated);
  }

  // ä½¿ç”¨æ¶ˆè€—å“
  Future<void> useConsumable(String itemId) async {
    final inventory = getInventory();
    final count = inventory.getConsumableCount(itemId);
    if (count <= 0) throw Exception('ç‰©å“ä¸è¶³');

    final newConsumables = Map<String, int>.from(inventory.consumables);
    newConsumables[itemId] = count - 1;

    final updated = inventory.copyWith(consumables: newConsumables);
    await saveInventory(updated);
  }

  // è·å–æ‰€æœ‰å•†å“
  List<ShopItem> getAllItems() {
    return ShopItem.defaultItems;
  }
}
```

#### 6. æ›´æ–° main.dart (10åˆ†é’Ÿ)

åœ¨ `main.dart` ä¸­æ³¨å†Œæ–°çš„é€‚é…å™¨ï¼š

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Hive.initFlutter();
  
  // æ³¨å†Œé€‚é…å™¨
  Hive.registerAdapter(WorkRecordAdapter());
  Hive.registerAdapter(WorkSettingsAdapter());
  Hive.registerAdapter(AdventurerProfileAdapter());
  Hive.registerAdapter(AppSettingsAdapter());
  Hive.registerAdapter(ProjectAdapter());        // æ–°å¢
  Hive.registerAdapter(ShopItemAdapter());       // æ–°å¢
  Hive.registerAdapter(InventoryAdapter());      // æ–°å¢

  await initializeProviders();

  runApp(const ProviderScope(child: MyApp()));
}
```

---

## âœ… Phase 1 å®Œæˆæ£€æŸ¥

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæ£€æŸ¥ï¼š

- [ ] æ‰€æœ‰æ–°æ¨¡å‹æ–‡ä»¶å·²åˆ›å»º
- [ ] Hive é€‚é…å™¨ç”ŸæˆæˆåŠŸï¼ˆ.g.dart æ–‡ä»¶å­˜åœ¨ï¼‰
- [ ] Repository æ–‡ä»¶å·²åˆ›å»º
- [ ] åº”ç”¨å¯ä»¥æ­£å¸¸ç¼–è¯‘è¿è¡Œ
- [ ] æ²¡æœ‰ç¼–è¯‘é”™è¯¯

è¿è¡Œæµ‹è¯•ï¼š
```bash
flutter run -d windows
```

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ å·²ç»å®Œæˆäº† Phase 1ï¼

---

## ğŸ“š ä¸‹ä¸€æ­¥

å®Œæˆ Phase 1 åï¼Œç»§ç»­ï¼š

1. **Phase 2**: åˆ›å»ºä¸šåŠ¡é€»è¾‘æœåŠ¡
2. **Phase 3**: å®ç°å•†åº—å’Œé¡¹ç›®ç®¡ç† UI
3. **Phase 4**: å®ç°æ‚¬æµ®çª—åŠŸèƒ½

è¯¦ç»†å†…å®¹è¯·å‚è€ƒ `V1.1.0_DEVELOPMENT_PLAN.md`

---

## ğŸ†˜ é‡åˆ°é—®é¢˜ï¼Ÿ

### å¸¸è§é—®é¢˜

**Q: build_runner ç”Ÿæˆå¤±è´¥ï¼Ÿ**
```bash
# æ¸…ç†åé‡æ–°ç”Ÿæˆ
flutter clean
flutter pub get
flutter packages pub run build_runner build --delete-conflicting-outputs
```

**Q: Hive typeId å†²çªï¼Ÿ**
- ç¡®ä¿æ¯ä¸ªæ¨¡å‹çš„ typeId å”¯ä¸€
- å½“å‰ä½¿ç”¨ï¼š0-3 (å·²æœ‰), 4-6 (æ–°å¢)

**Q: ç¼–è¯‘é”™è¯¯ï¼Ÿ**
- æ£€æŸ¥æ‰€æœ‰ import è¯­å¥
- ç¡®ä¿ part å’Œ part of æ­£ç¡®
- è¿è¡Œ `flutter pub get`

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹ç¼–ç å§ï¼** ğŸš€
