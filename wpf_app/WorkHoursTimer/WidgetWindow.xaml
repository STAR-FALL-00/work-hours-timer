<Window x:Class="WorkHoursTimer.WidgetWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:WorkHoursTimer.Converters"
        xmlns:controls="clr-namespace:WorkHoursTimer.Controls"
        xmlns:helpers="clr-namespace:WorkHoursTimer.Helpers"
        Title="Widget"
        Width="300"
        Height="140"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        MouseLeftButtonDown="Window_MouseLeftButtonDown"
        MouseRightButtonUp="Window_MouseRightButtonUp">
    
    <Window.Resources>
        <!-- Percent to Width Converter -->
        <local:PercentToWidthConverter x:Key="PercentToWidthConverter" MaxWidth="280"/>
        
        <!-- Bool to Scale Converter for Flipping -->
        <local:BoolToScaleConverter x:Key="BoolToScaleConverter"/>
        
        <!-- Boss Battle Mode Template -->
        <DataTemplate x:Key="BossBattleTemplate">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="96"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Battle Area: Canvas for absolute positioning -->
                <Canvas Grid.Row="0" Width="280" Height="96" HorizontalAlignment="Center">
                    <!-- Hero (ç«™åœ¨åº•éƒ¨) -->
                    <controls:PixelActor x:Name="HeroActor"
                                         FramePaths="{Binding HeroFrames}"
                                         Width="96" Height="96" 
                                         Canvas.Bottom="0"
                                         FrameInterval="100"
                                         AutoPlay="True"
                                         RenderTransformOrigin="0.5,1">
                        <controls:PixelActor.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform ScaleX="{Binding HeroFlipped, Converter={StaticResource BoolToScaleConverter}}"/>
                                <TranslateTransform X="{Binding HeroX}"/>
                            </TransformGroup>
                        </controls:PixelActor.RenderTransform>
                    </controls:PixelActor>
                    
                    <!-- Boss (ç«™åœ¨åº•éƒ¨ï¼ŒYè½´ç”¨äºŽè·³è·ƒ) -->
                    <controls:PixelActor x:Name="BossActor"
                                         FramePaths="{Binding BossFrames}"
                                         Width="96" Height="96"
                                         Canvas.Bottom="0"
                                         FrameInterval="150"
                                         AutoPlay="True"
                                         RenderTransformOrigin="0.5,1">
                        <controls:PixelActor.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform ScaleX="{Binding BossFlipped, Converter={StaticResource BoolToScaleConverter}}"/>
                                <TranslateTransform X="{Binding BossX}">
                                    <TranslateTransform.Y>
                                        <Binding Path="BossY">
                                            <Binding.Converter>
                                                <local:NegateConverter/>
                                            </Binding.Converter>
                                        </Binding>
                                    </TranslateTransform.Y>
                                </TranslateTransform>
                            </TransformGroup>
                        </controls:PixelActor.RenderTransform>
                    </controls:PixelActor>
                </Canvas>
                
                <!-- Bottom Row: Boss HP Bar -->
                <Grid Grid.Row="1" Margin="0,8,0,0">
                    <Border Background="#40FF0000" CornerRadius="8" Height="32"/>
                    <Border Background="#FFFF4757" CornerRadius="8" 
                            Height="32" HorizontalAlignment="Left"
                            Width="{Binding BossHealth, Converter={StaticResource PercentToWidthConverter}, ConverterParameter=280}"/>
                </Grid>
            </Grid>
        </DataTemplate>
        
        <!-- Runner Cat Mode Template -->
        <DataTemplate x:Key="RunnerCatTemplate">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Cat Character -->
                <controls:PixelActor Grid.Row="0" 
                                     FramePaths="{Binding CatFrames}"
                                     Width="40" Height="40"
                                     FrameInterval="120"
                                     AutoPlay="True"
                                     HorizontalAlignment="Left" Margin="20,0,0,0"/>
                
                <!-- Progress Track -->
                <Grid Grid.Row="1" Margin="0,8,0,8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Track Background -->
                    <Border Grid.Row="0" Background="#40FFFFFF" CornerRadius="4" Height="16"/>
                    
                    <!-- Progress Bar -->
                    <Border Grid.Row="0" Background="#FF5DADE2" CornerRadius="4" 
                            Height="16" HorizontalAlignment="Left"
                            Width="{Binding HeroProgress, Converter={StaticResource PercentToWidthConverter}}"/>
                    
                    <!-- Milestones -->
                    <Grid Grid.Row="1" Margin="0,2,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="0h" FontSize="10" 
                                   Foreground="#A0A0B0" HorizontalAlignment="Left"/>
                        <TextBlock Grid.Column="1" Text="4h" FontSize="10" 
                                   Foreground="#A0A0B0" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="2" Text="8h" FontSize="10" 
                                   Foreground="#A0A0B0" HorizontalAlignment="Right"/>
                    </Grid>
                </Grid>
                
                <!-- Timer Display -->
                <TextBlock Grid.Row="2" Text="{Binding TimerText}" 
                           FontSize="28" FontWeight="Bold" Foreground="#5DADE2"
                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                
                <!-- Bottom Row: Resources -->
                <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center">
                    <controls:PixelActor FramePaths="{Binding CoinFrames}"
                                         Width="20" Height="20"
                                         FrameInterval="100"
                                         AutoPlay="True"
                                         VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding GoldEarned}" FontSize="14" Foreground="#FFD700" 
                               FontWeight="Bold" VerticalAlignment="Center" Margin="4,0,0,0"/>
                </StackPanel>
            </Grid>
        </DataTemplate>
    </Window.Resources>
    
    <!-- Content Container (æ— èƒŒæ™¯ï¼Œå®Œå…¨é€æ˜Ž) -->
    <ContentControl x:Name="ContentContainer" Content="{Binding}">
        <ContentControl.ContextMenu>
            <ContextMenu>
                <MenuItem Header="åˆ‡æ¢çš®è‚¤">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸŽ¨"/>
                    </MenuItem.Icon>
                    <MenuItem Header="å‹‡è€…ä¼é­”" Click="SwitchToBossBattle_Click">
                        <MenuItem.Icon>
                            <TextBlock Text="âš”ï¸"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="è·‘é…·çŒ«å’ª" Click="SwitchToRunnerCat_Click">
                        <MenuItem.Icon>
                            <TextBlock Text="ðŸ±"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </MenuItem>
                <Separator/>
                <MenuItem Header="å…³é—­æŒ‚ä»¶" Click="CloseMenuItem_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="âœ•" Foreground="#FF4757" FontWeight="Bold"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="ç½®é¡¶" IsCheckable="True" IsChecked="True" Click="TopMostMenuItem_Click">
                    <MenuItem.Icon>
                        <TextBlock Text="ðŸ“Œ"/>
                    </MenuItem.Icon>
                </MenuItem>
            </ContextMenu>
        </ContentControl.ContextMenu>
        
        <ContentControl.Style>
            <Style TargetType="ContentControl">
                <Setter Property="ContentTemplate" Value="{StaticResource BossBattleTemplate}"/>
                <Style.Triggers>
                    <DataTrigger Binding="{Binding CurrentSkin}" Value="runner_cat">
                        <Setter Property="ContentTemplate" Value="{StaticResource RunnerCatTemplate}"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </ContentControl.Style>
    </ContentControl>
</Window>
