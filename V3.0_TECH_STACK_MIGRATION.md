# Work Hours Timer v3.0 - 技术栈迁移决策

## 📋 迁移概述

**日期**: 2026-02-27  
**决策**: 从 Flutter 迁移到 WPF/C#/.NET 8  
**原因**: 实现更好的 Windows 原生体验和性能优化

---

## 🎯 迁移原因

### Flutter 的局限性
1. **窗口特效性能**: 实现 Windows 11 Mica/Acrylic 效果需要复杂的 Win32 API 调用
2. **鼠标穿透**: 像素级鼠标穿透实现复杂，性能开销大
3. **内存占用**: Flutter 桌面应用静默运行时内存占用较高（>100MB）
4. **多窗口通信**: `desktop_multi_window` 插件存在稳定性问题

### WPF 的优势
1. **原生特效**: WPF-UI 库直接支持 Mica/Acrylic 背景，无需底层 API
2. **窗口控制**: 完美的 Win32 API 集成，精确控制窗口行为
3. **性能优化**: 静默运行内存占用可控制在 50MB 以内
4. **开发效率**: XAML + MVVM 模式成熟，社区资源丰富

---

## 🏗️ 新技术栈

### 核心框架
- **Framework**: .NET 8 (LTS)
- **UI Framework**: WPF (Windows Presentation Foundation)
- **UI Library**: WPF-UI (Wpf.Ui) - 现代化 Win11 风格
- **MVVM**: CommunityToolkit.Mvvm - 微软官方推荐

### 关键依赖
- **XamlAnimatedGif**: GIF 动画播放（像素挂件）
- **System.Text.Json**: 本地数据存储
- **LiveCharts2** 或 **ScottPlot**: 数据图表

---

## 📂 新项目结构

```
wpf_app/
├── WorkHoursTimer.sln              # 解决方案文件
├── WorkHoursTimer/                 # 主项目
│   ├── App.xaml                    # 应用程序入口
│   ├── App.xaml.cs
│   ├── MainWindow.xaml             # 主窗口（侧边栏）
│   ├── MainWindow.xaml.cs
│   ├── WidgetWindow.xaml           # 挂件窗口
│   ├── WidgetWindow.xaml.cs
│   ├── Models/                     # 数据模型
│   │   ├── WorkRecord.cs
│   │   ├── Project.cs
│   │   ├── Settings.cs
│   │   └── AdventurerProfile.cs
│   ├── ViewModels/                 # 视图模型（MVVM）
│   │   ├── MainViewModel.cs
│   │   ├── TimerViewModel.cs
│   │   ├── StatsViewModel.cs
│   │   └── WidgetViewModel.cs
│   ├── Views/                      # 用户控件
│   │   ├── TimerView.xaml
│   │   ├── StatsView.xaml
│   │   └── ShopView.xaml
│   ├── Services/                   # 业务逻辑
│   │   ├── TimerService.cs
│   │   ├── DataService.cs
│   │   ├── WindowService.cs
│   │   └── AudioService.cs
│   ├── Helpers/                    # 工具类
│   │   ├── Win32Helper.cs          # Win32 API 封装
│   │   └── JsonHelper.cs
│   ├── Resources/                  # 资源文件
│   │   ├── Styles/
│   │   ├── Images/
│   │   └── Audio/
│   └── Assets/                     # 像素素材
│       └── Animations/
└── README.md
```

---

## 🔄 数据迁移策略

### Hive → JSON
Flutter 使用 Hive 数据库，WPF 使用 JSON 文件存储。

**迁移路径**:
```
flutter_app/data/hive/
  ├── work_records.hive
  ├── projects.hive
  └── settings.hive
    ↓ 转换
wpf_app/AppData/
  └── data.json  (统一 JSON 文件)
```

**数据结构兼容**:
- 保持相同的字段名称
- 日期格式统一为 ISO 8601
- 创建迁移工具脚本

---

## 📅 开发计划

### 🟢 第一周：骨架构建 (Week 1)
**目标**: 搭建 WPF 项目，实现双窗口基础框架

**任务**:
- [x] 创建 WPF 解决方案
- [ ] 配置 WPF-UI 库
- [ ] 实现主窗口（侧边栏）
  - [ ] Mica/Acrylic 背景
  - [ ] 右侧停靠逻辑
  - [ ] 自动隐藏/唤出
- [ ] 实现挂件窗口
  - [ ] 透明背景
  - [ ] 鼠标穿透（Win32 API）
  - [ ] 拖拽功能
- [ ] 窗口间通信（事件总线）

**交付物**: 两个窗口可以同时运行，基础交互正常

---

### 🟡 第二周：业务逻辑 (Week 2)
**目标**: 实现核心功能，数据持久化

**任务**:
- [ ] MVVM 架构搭建
- [ ] 计时器服务
- [ ] 项目管理
- [ ] 金币/经验系统
- [ ] JSON 数据存储
- [ ] 从 Flutter 迁移数据

**交付物**: 核心功能可用，数据可保存和读取

---

### 🔴 第三周：视觉与动画 (Week 3)
**目标**: UI 美化，动画效果

**任务**:
- [ ] 导入 UI 设计素材
- [ ] XAML 样式美化
- [ ] 接入像素动画（GIF）
- [ ] 音效系统
- [ ] 过渡动画
- [ ] 性能优化

**交付物**: 完整的 v3.0 应用，可发布

---

## 🎨 UI 设计规范

### 调色板
```xml
<SolidColorBrush x:Key="PrimaryDeep" Color="#1A1A2E"/>    <!-- 深空蓝 -->
<SolidColorBrush x:Key="AccentGold" Color="#FFD700"/>     <!-- 金币色 -->
<SolidColorBrush x:Key="TextPrimary" Color="#FFFFFF"/>    <!-- 主文本 -->
<SolidColorBrush x:Key="TextSecondary" Color="#A0A0B0"/>  <!-- 次级文本 -->
<SolidColorBrush x:Key="Danger" Color="#FF4757"/>         <!-- BOSS血条 -->
```

### 字体
- **数字/英文**: Poppins (Bold)
- **中文**: MiSans（小米字体，免费商用）
- **像素字体**: Zpix（挂件专用）

---

## ⚠️ 风险与挑战

### 技术风险
1. **学习曲线**: 团队需要熟悉 C# 和 WPF
2. **跨平台**: WPF 仅支持 Windows，放弃 macOS/Linux
3. **数据迁移**: 需要确保用户数据完整迁移

### 缓解措施
1. 提供详细的技术文档和代码示例
2. 明确定位为 Windows 专属应用
3. 创建自动化迁移工具

---

## ✅ 下一步行动

1. **立即**: 创建 WPF 项目结构
2. **Day 1**: 配置开发环境，安装 Visual Studio 2022
3. **Day 2**: 实现主窗口基础框架
4. **Day 3**: 实现挂件窗口和鼠标穿透

---

## 📚 参考资源

- [WPF-UI 官方文档](https://wpfui.lepo.co/)
- [.NET 8 文档](https://learn.microsoft.com/dotnet/)
- [CommunityToolkit.Mvvm](https://learn.microsoft.com/windows/communitytoolkit/mvvm/)
- [像素素材 - itch.io](https://itch.io/game-assets/free/tag-pixel-art)
