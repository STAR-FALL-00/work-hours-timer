# 实施计划: 工时计算工具

## 概述

本实施计划将工时计算工具的设计转化为可执行的编码任务。系统采用 TypeScript 实现，使用模块化架构，包含核心计算层、分析层、存储层和导出层。实施将按照从底层到上层的顺序进行，确保每个模块都经过充分测试后再进行集成。

## 任务

- [x] 1. 搭建项目结构和核心类型定义
  - 创建项目目录结构（src/core, src/analysis, src/storage, src/export）
  - 定义核心时间类型（DateTime, Date, Time, Duration, TimeRange, DateRange）
  - 定义常量（STANDARD_WORK_HOURS, PERIOD_DEFINITIONS）
  - 配置 TypeScript 编译选项和测试框架
  - _需求: 所有需求的基础_

- [x] 2. 实现核心数据模型和验证服务
  - [x] 2.1 实现 WorkRecord 数据模型
    - 创建 WorkRecord 接口和实现类
    - 实现工作时长计算方法
    - _需求: 1.1_
  
  - [x] 2.2 实现 ValidationService
    - 实现工作记录验证逻辑（开始时间必须早于结束时间）
    - 实现日期范围验证逻辑
    - 返回详细的 ValidationResult
    - _需求: 1.2, 1.3_
  
  - [x] 2.3 编写 ValidationService 的属性测试
    - **属性 2: 时间顺序验证**
    - **验证需求: 1.2, 1.3**
  
  - [x] 2.4 编写 WorkRecord 的单元测试
    - 测试有效工作记录的创建
    - 测试工作时长计算
    - 测试边界情况
    - _需求: 1.1_

- [x] 3. 实现存储层
  - [x] 3.1 定义 RecordRepository 接口
    - 定义 save, findByDate, findByDateRange, findAll 方法
    - _需求: 1.4, 8.1, 8.3_
  
  - [x] 3.2 实现内存存储适配器 (InMemoryStorageAdapter)
    - 实现基于 Map 的内存存储
    - 实现按日期和日期范围的查询逻辑
    - 实现结果按时间排序
    - _需求: 1.4, 8.1, 8.2, 8.3_
  
  - [x] 3.3 编写存储层的属性测试
    - **属性 1: 工作记录持久化往返**
    - **属性 14: 日期范围查询正确性**
    - **属性 15: 查询结果时间排序**
    - **属性 16: 单日查询正确性**
    - **验证需求: 1.1, 1.4, 8.1, 8.2, 8.3**
  
  - [x] 3.4 编写存储层的单元测试
    - 测试空存储的查询
    - 测试单条记录的保存和查询
    - 测试多条记录的查询和排序
    - _需求: 1.4, 8.1, 8.2, 8.3_

- [x] 4. 实现 WorkHoursCalculator 核心计算器
  - [x] 4.1 实现 WorkHoursCalculator 类
    - 实现 addWorkRecord 方法（集成 ValidationService）
    - 实现 getDailyWorkHours 方法（计算总时长、已工作时长、剩余时长、加班时长）
    - 实现 getWorkRecords 方法（支持日期和日期范围查询）
    - _需求: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 8.1, 8.2, 8.3_
  
  - [x] 4.2 编写 WorkHoursCalculator 的属性测试
    - **属性 3: 每日总工作时长计算**
    - **属性 4: 剩余工作时长计算**
    - **属性 5: 加班时长计算**
    - **验证需求: 2.1, 2.3, 2.4, 2.5**
  
  - [x] 4.3 编写 WorkHoursCalculator 的单元测试
    - 测试标准8小时工作日
    - 测试加班场景
    - 测试不足8小时场景
    - 测试无效记录的拒绝
    - _需求: 1.2, 1.3, 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 5. 检查点 - 确保核心功能测试通过
  - 确保所有测试通过，如有疑问请询问用户。

- [x] 6. 实现时段分析器 (PeriodAnalyzer)
  - [x] 6.1 实现 PeriodAnalyzer 类
    - 实现时段识别逻辑（上午、中午、下午）
    - 实现跨时段工作记录的时长分配算法
    - 实现各时段平均工作时长计算
    - 实现上午平均开始时间计算
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 9.1, 9.2_
  
  - [x] 6.2 编写 PeriodAnalyzer 的属性测试
    - **属性 6: 时段识别和分配**
    - **属性 7: 时段分配守恒**
    - **属性 8: 时段平均时长计算**
    - **属性 9: 上午平均开始时间计算**
    - **验证需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 9.1, 9.2**
  
  - [x] 6.3 编写 PeriodAnalyzer 的单元测试
    - 测试单时段工作记录
    - 测试跨时段工作记录
    - 测试时段边界情况（如12:00:00）
    - 测试空记录列表
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 9.1, 9.2_

- [x] 7. 实现聚合统计器 (AggregationAnalyzer)
  - [x] 7.1 实现 AggregationAnalyzer 类
    - 实现 generateDailyReport 方法
    - 实现 generateWeeklyReport 方法
    - 实现 generateMonthlyReport 方法
    - 实现 generateYearlyReport 方法（包含按月分组）
    - 集成 PeriodAnalyzer 获取时段统计
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8_
  
  - [x] 7.2 编写 AggregationAnalyzer 的属性测试
    - **属性 10: 报告字段完整性**
    - **属性 11: 聚合总计正确性**
    - **属性 12: 平均每日工作时长计算**
    - **属性 13: 工作天数计算**
    - **验证需求: 4.1-4.5, 5.1-5.6, 6.1-6.7, 7.1-7.8**
  
  - [x] 7.3 编写 AggregationAnalyzer 的单元测试
    - 测试日报告生成
    - 测试周报告生成
    - 测试月报告生成
    - 测试年报告生成（包含月度分组）
    - 测试空数据的处理
    - _需求: 4.1-4.5, 5.1-5.6, 6.1-6.7, 7.1-7.8_

- [ ] 8. 检查点 - 确保分析功能测试通过
  - 确保所有测试通过，如有疑问请询问用户。

- [x] 9. 实现报告导出器 (ReportExporter)
  - [x] 9.1 实现 DataSerializer 类
    - 实现 JSON 序列化逻辑
    - 实现 JSON 反序列化逻辑
    - 处理各种报告类型（DailyReport, WeeklyReport, MonthlyReport, YearlyReport）
    - _需求: 10.1, 10.2, 10.3_
  
  - [x] 9.2 实现 ReportExporter 类
    - 实现 exportDailyReport 方法
    - 实现 exportWeeklyReport 方法
    - 实现 exportMonthlyReport 方法
    - 实现 exportYearlyReport 方法
    - 实现 importReport 方法
    - _需求: 10.1, 10.2, 10.3_
  
  - [x] 9.3 编写 ReportExporter 的属性测试
    - **属性 17: 报告导出格式有效性**
    - **属性 18: 报告序列化往返**
    - **验证需求: 10.1, 10.2, 10.3**
  
  - [x] 9.4 编写 ReportExporter 的单元测试
    - 测试各类型报告的导出
    - 测试导入功能
    - 测试往返一致性
    - 测试无效数据的处理
    - _需求: 10.1, 10.2, 10.3_

- [x] 10. 集成和错误处理完善
  - [x] 10.1 完善错误处理机制
    - 实现 Result 类型的错误传播
    - 完善各模块的错误处理逻辑
    - 确保错误消息清晰明确
    - _需求: 所有需求的错误处理_
  
  - [x] 10.2 编写集成测试
    - 测试完整的记录添加到报告生成流程
    - 测试多日数据的端到端处理
    - 测试导出和导入的完整流程
    - _需求: 所有需求的集成验证_

- [ ] 11. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有疑问请询问用户。

## 注意事项

- 标记 `*` 的任务为可选任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
- 所有属性测试应至少运行 100 次迭代
- 属性测试必须用注释标记对应的设计属性：`// Feature: work-hours-calculator, Property {number}: {property_text}`
